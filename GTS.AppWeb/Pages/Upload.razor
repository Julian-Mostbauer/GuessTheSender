@page "/upload"
@using GTS.Core
@inject GTS.AppWeb.Services.MessageService MessageService
@inject NavigationManager NavigationManager

@code {
    private string? errorMessage = null;
    private bool hasTriedLoading = false;
    private bool isLoading = false;

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        hasTriedLoading = true;
        isLoading = true;
        try
        {
            var file = e.File;
            await using var stream = file.OpenReadStream(maxAllowedSize: 1_024_000);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
            var messageLoader = MessageLoader.FromContent(content);
            var messages = messageLoader.LoadMessages().ToArray();
            MessageService.SetMessages(messages);
            errorMessage = null;
        }
        catch (IOException ioEx)
        {
            errorMessage = $"File size exceeds limit: {ioEx.Message}";
            MessageService.SetMessages(null);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading messages: {ex.Message}";
            MessageService.SetMessages(null);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearMessages()
    {
        MessageService.ClearMessages();
        hasTriedLoading = false;
    }

}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-4 text-center">Upload Your Messages</h2>
                    <p class="text-muted text-center">Select a file containing your messages to get started. Supported
                        formats: .txt, .csv</p>
                    <div class="mb-3 text-center">
                        <InputFile class="form-control" OnChange="OnInputFileChange"/>
                    </div>
                    <button class="btn btn-outline-danger mb-3 w-100" @onclick="ClearMessages"
                            disabled="@(MessageService.Messages == null)" style="display:none;">Clear All Messages
                    </button>
                    <div class="mt-4">
                        @if (MessageService.Messages is { Length: > 0 })
                        {
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Success!</strong> @MessageService.Messages.Length messages have been loaded.
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-3" @onclick="ClearMessages"
                                        title="Clear All Messages">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                        }
                        else if (isLoading)
                        {
                            <div class="alert alert-info text-center">
                                <span class="spinner-border spinner-border-sm me-2"></span>Loading messages, please
                                wait...
                            </div>
                        }
                        else if (!hasTriedLoading)
                        {
                            <div class="alert alert-secondary text-center">
                                No messages have been loaded yet. Please upload a file to begin.
                            </div>
                        }
                        else if (MessageService.Messages == null)
                        {
                            <div class="alert alert-danger text-center">
                                <strong>Failed to load messages.</strong><br/>
                                <span>@(errorMessage ?? "An unknown error occurred. Please try again.")</span>
                            </div>
                        }
                        else if (MessageService.Messages.Length == 0)
                        {
                            <div class="alert alert-warning text-center">
                                The file was loaded, but no messages were found.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

